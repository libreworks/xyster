<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>4.3. Plugins</title>
<link rel="stylesheet" href="dbstyle.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.72.0">
<link rel="start" href="index.html" title="Programmer's Reference Guide">
<link rel="up" href="xyster.controller.html" title="Chapter 4. Xyster_Controller">
<link rel="prev" href="xyster.controller.actionhelpers.html" title="4.2. Action Helpers">
<link rel="next" href="xyster.data.html" title="Chapter 5. Xyster_Data">
<link rel="chapter" href="introduction.html" title="Chapter 1. Introduction to Xyster Framework">
<link rel="chapter" href="xyster.acl.html" title="Chapter 2. Xyster_Acl">
<link rel="chapter" href="xyster.collection.html" title="Chapter 3. Xyster_Collection">
<link rel="chapter" href="xyster.controller.html" title="Chapter 4. Xyster_Controller">
<link rel="chapter" href="xyster.data.html" title="Chapter 5. Xyster_Data">
<link rel="chapter" href="xyster.date.html" title="Chapter 6. Xyster_Date">
<link rel="chapter" href="xyster.enum.html" title="Chapter 7. Xyster_Enum">
<link rel="chapter" href="xyster.filter.html" title="Chapter 8. Xyster_Filter">
<link rel="chapter" href="xyster.orm.html" title="Chapter 9. Xyster_Orm">
<link rel="chapter" href="xyster.type.html" title="Chapter 10. Xyster_Type">
<link rel="chapter" href="xyster.validate.html" title="Chapter 11. Xyster_Validate">
<link rel="subsection" href="xyster.controller.plugins.html#xyster.controller.plugins.acl" title="4.3.1. Xyster_Controller_Plugin_Acl">
<link rel="subsection" href="xyster.controller.plugins.html#xyster.controller.plugins.auth" title="4.3.2. Xyster_Controller_Plugin_Auth">
<link rel="subsection" href="xyster.controller.plugins.html#xyster.controller.plugins.cache" title="4.3.3. Xyster_Controller_Plugin_Cache">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader"><table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">4.3. Plugins</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="xyster.controller.actionhelpers.html">Prev</a> </td>
<th width="60%" align="center">Chapter 4. Xyster_Controller</th>
<td width="20%" align="right"> <a accesskey="n" href="xyster.data.html">Next</a>
</td>
</tr>
</table></div>
<div class="sect1" lang="en">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="xyster.controller.plugins"></a>4.3. Plugins</h2></div></div></div>
<p>These are the Controller Plugins included in the Xyster distribution. For information about
				Controller Plugins themselves, see the documentation for
			<a href="http://framework.zend.com/manual/en/zend.controller.plugins.html" target="_top">Controller Plugins</a>.</p>
<div class="sect2" lang="en">
<div class="titlepage"><div><div><h3 class="title">
<a name="xyster.controller.plugins.acl"></a>4.3.1. Xyster_Controller_Plugin_Acl</h3></div></div></div>
<p>The ACL plugin is used to grant roles access to MVC dispatch locations. Given a
					<code class="classname">Zend_Acl</code> or <code class="classname">Xyster_Acl</code>, you can use
					this plugin to allow or deny a role access to an entire module, just a controller, or a
					single action. If the authenticated user tries to access a location that is forbidden,
					the plugin forwards them to an error action.</p>
<div class="sect3" lang="en">
<div class="titlepage"><div><div><h4 class="title">
<a name="xyster.controller.plugins.acl.error"></a>4.3.1.1. Setting the Error and Unauthenticated Locations</h4></div></div></div>
<p>Like Zend's ErrorHandler plugin, the default is <code class="code">ErrorController::errorAction()</code>
					in the default module. We made the request variables the plugin makes available to that action identical
					to those set up by ErrorHandler to provide reuse. You can change the forward location if you desire.</p>
<pre class="programlisting">&lt;?php
$module = 'default';
$controller = 'index';
$action = 'error';
/* @var $plugin Xyster_Controller_Plugin_Acl */
$plugin-&gt;setAccessDenied($module, $controller, $action);</pre>
<p>The plugin registers a preDispatch hook to verify access. If the authenticated user
						isn't allowed to access the action about to be dispatched, the plugin forwards them to the
						error location specified.</p>
<div class="tip"><table border="0" summary="Tip">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td>
<th align="left">Tip</th>
</tr>
<tr><td align="left" valign="top"><p>This plugin assumes that the currently authenticated <code class="classname">Zend_Auth</code> identity has been added
						as a role to the ACL. <code class="classname">Xyster_Controller_Plugin_Auth</code> when used will add the current
						authenticated role to the ACL during the routeStartup event.</p></td></tr>
</table></div>
<p>If an action is denied but the user isn't authenticated (meaning <code class="classname">Zend_Auth</code>
						doesn't have an identity), the plugin will forward them to a location where they should be
						prompted for credentials. By default, this is the 'index' action of the 'login' controller in the
						default module. This can be changed by using the <code class="methodname">setLogin</code> method.</p>
<pre class="programlisting">&lt;?php
$module = 'default';
$controller = 'index';
$action = 'login';
/* @var $plugin Xyster_Controller_Plugin_Acl */
$plugin-&gt;setLogin($module, $controller, $action);</pre>
<p>The login action should process the the user-supplied credentials and authenticate the user.</p>
<div class="tip"><table border="0" summary="Tip">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td>
<th align="left">Tip</th>
</tr>
<tr><td align="left" valign="top"><p>If you use <code class="classname">Xyster_Controller_Plugin_Auth</code>, you can set the adapter
							it uses within your login action. Doing so will automatically authenticate the user and
							assign the role to the ACL.</p></td></tr>
</table></div>
</div>
<div class="sect3" lang="en">
<div class="titlepage"><div><div><h4 class="title">
<a name="xyster.controller.plugins.acl.rules"></a>4.3.1.2. Adding Rules</h4></div></div></div>
<p>You can set up the access control rules using the <code class="methodname">allow</code>,
						<code class="methodname">deny</code>, and <code class="methodname">setRules</code> methods on the plugin.
						The rules must be defined before the Front Controller dispatches the request.
						Remember that the role used in the rule must be defined in the ACL before you can add the rule.
						The following example allows the authenticated user access to all actions in the
						'foo' controller of the 'default' module.</p>
<pre class="programlisting">&lt;?php
$acl = new Zend_Acl;
$identity = Zend_Auth::getInstance()-&gt;getIdentity();
$acl-&gt;addRole(new Zend_Acl_Role($identity);
$plugin = new Xyster_Controller_Plugin_Acl($acl);
$plugin-&gt;allow($identity, 'default', 'foo');
$front = Zend_Controller_Front::getInstance();
$front-&gt;registerPlugin($plugin);</pre>
<div class="note"><table border="0" summary="Note">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top"><p>The ACL Plugin stores the dispatch locations as
							<code class="classname">Xyster_Controller_Request_Resource</code> objects.
							Each one represents a module, controller, or action. They are added hierarchically
							to the ACL. Therefore, adding a rule for access to the "bar" action in the "foo" controller
							in the "default" module will add three resources to the ACL: /default, /default/foo,
							and /default/foo/bar.</p></td></tr>
</table></div>
<p>You can add as many rules as you want using the fluent interface of the allow method. </p>
<pre class="programlisting">&lt;?php
$plugin-&gt;allow('admin', null) // admin can access everything
	-&gt;allow('moderators', 'forum', 'mod') // moderators can access the 'mod' controller
	-&gt;allow(null, 'forum', 'view') // all users can access the 'view' controller
	-&gt;deny('trolls'); // all forum trolls should be forbidden</pre>
<p>You can also add multiple rules at once by passing an array to the <code class="methodname">setRules</code>
						method. Each element in the array must be an array with several keys.</p>
<div class="orderedlist"><ol type="1">
<li><p>"<em class="structfield"><code>type</code></em>" : either <code class="constant">Zend_Acl::TYPE_ALLOW</code> or <code class="constant">Zend_Acl::TYPE_DENY</code></p></li>
<li><p>"<em class="structfield"><code>role</code></em>" : the string role ID</p></li>
<li><p>"<em class="structfield"><code>module</code></em>" : the module name</p></li>
<li><p>"<em class="structfield"><code>controller</code></em>" : the controller name</p></li>
<li><p>"<em class="structfield"><code>action</code></em>" : the action name</p></li>
</ol></div>
<p>If 'type' is omitted or is null, <code class="code">Zend_Acl::TYPE_ALLOW</code> is assumed. If any of the
						other keys are omitted, null is assumed.</p>
<pre class="programlisting">&lt;?php
$rules = array(
    array('role'=&gt;'admin'),
    array('role'=&gt;'moderators', 'module'=&gt;'forum', 'controller'=&gt;'mod'), 
    array('module'=&gt;'forum', 'controller'=&gt;'view'),
    array('type'=&gt;Zend_Acl::TYPE_DENY, 'role'=&gt;'trolls')
);
/* @var $plugin Xyster_Controller_Plugin_Acl */
$plugin-&gt;setRules($rules);</pre>
</div>
</div>
<div class="sect2" lang="en">
<div class="titlepage"><div><div><h3 class="title">
<a name="xyster.controller.plugins.auth"></a>4.3.2. Xyster_Controller_Plugin_Auth</h3></div></div></div>
<p>The main purpose of the authentication plugin is to authenticate the current user and register
					it with a supplied ACL. The plugin registers a routeStartup hook so authentication can take place
					before the MVC system does any real work.</p>
<p>The plugin can be given an
					<a href="http://framework.zend.com/manual/en/zend.auth.html#zend.auth.introduction.adapters" target="_top">auth adapter</a>
					with the <code class="methodname">setAuthAdapter</code> method that can be used to authenticate the user.
					The adapter will only be used if <code class="classname">Zend_Auth</code> doesn't have the identity of
					the user. If your adapter doesn't take any arguments or credentials from the user, it is acceptable
					to supply the adapter immediately after the plugin is constructed.</p>
<pre class="programlisting">&lt;?php
$adapter = new MyAuthAdapter;
$plugin = new Xyster_Controller_Plugin_Auth;
$plugin-&gt;setAuthAdapter($adapter);</pre>
<p>If the user must supply credentials for authentication, the adapter can and should be created
					and supplied within a controller action that processes the user's credentials.</p>
<pre class="programlisting">&lt;?php
public function loginAction()
{
	if ( $this-&gt;getRequest()-&gt;isPost() ) {
		$username = $this-&gt;_getParam('username');
		$password = $this-&gt;_getParam('password');
		$adapter = new MyAuthAdapter($username, $password);
		$plugin = $this-&gt;getFrontController()-&gt;getPlugin('Xyster_Controller_Plugin_Auth');
		$plugin-&gt;setAuthAdapter($adapter);
		return;
	} else {
		// show login form
	}
}</pre>
<div class="sect3" lang="en">
<div class="titlepage"><div><div><h4 class="title">
<a name="xyster.controller.plugins.auth.actions"></a>4.3.2.1. The Success and Failure Actions</h4></div></div></div>
<p>At the routeStartup event or when given an adapter, the plugin will try to authenticate
						the user if an identity has not been stored. If the authentication fails, the user will
						be forwarded to a login failure action. By default, this is the 'index' action of the
						'login' controller in the default module. You can change this using the <code class="methodname">setFailure</code> method.</p>
<pre class="programlisting">&lt;?php
$module = 'default';
$controller = 'index';
$action = 'login';
/* @var $plugin Xyster_Controller_Plugin_Auth */
$plugin-&gt;setFailure($module, $controller, $action);</pre>
<p>A <code class="classname">Zend_Auth_Result</code> object will be passed to this action as the result parameter.</p>
<p>If the authentication succeeds, the user will be forwarded to a login success action. By default, this is the
						'success' action of the 'login' controller in the default module. You can change this using the
						<code class="methodname">setSuccess</code> method.</p>
<pre class="programlisting">&lt;?php
$module = 'default';
$controller = 'index';
$action = 'myAccount';
/* @var $plugin Xyster_Controller_Plugin_Auth */
$plugin-&gt;setSuccess($module, $controller, $action);</pre>
</div>
<div class="sect3" lang="en">
<div class="titlepage"><div><div><h4 class="title">
<a name="xyster.controller.plugins.auth.role"></a>4.3.2.2. Getting the Identity's Role</h4></div></div></div>
<p>Once the user is authenticated, the plugin will then retrieve and store a role that represents
						the authenticated user. By default, <code class="classname">Xyster_Acl_Role_Provider</code> will be used,
						but you can define your own provider using the <code class="methodname">setRoleProvider</code> method.
						If an ACL object is supplied, the plugin will take the role it got from the provider and add it
						to the ACL.</p>
<pre class="programlisting">&lt;?php
$acl = new Zend_Acl;
$authAdapter = new MyAuthAdapter();
$plugin = new Xyster_Controller_Plugin_Auth($authAdapter, $acl);
$front = Zend_Controller_Front::getInstance();
$front-&gt;registerPlugin($plugin);</pre>
<p>Once authentication takes place, the role generated for the current user is available from the getRole method.</p>
</div>
</div>
<div class="sect2" lang="en">
<div class="titlepage"><div><div><h3 class="title">
<a name="xyster.controller.plugins.cache"></a>4.3.3. Xyster_Controller_Plugin_Cache</h3></div></div></div>
<p>The Cache plugin is responsible for one thing: providing the correct cache control headers. </p>
<p>Common problem: During a started session, PHP will by default send several anti-caching headers
					along with the response. Simply including this plugin class turns off the configuration setting
					that enables this. This plugin should be included before the session is started or any output is
					sent to the browser.</p>
<p>The Cache plugin registers a dispatchLoopShutdown hook so that the correct cache headers can be sent.
					There are four scenarios:</p>
<div class="orderedlist"><ol type="1">
<li><p>You haven't sent any cache-control headers; default anti-caching headers will be sent as
						well as the content-length of the response body.</p></li>
<li><p>You've sent cache-control headers; only the content-length of the response body will be sent.</p></li>
<li><p>You've sent a content-type header signifying a file transfer; no headers will be sent.</p></li>
<li><p>The response is a redirect; no headers will be sent.</p></li>
</ol></div>
</div>
</div>
<div class="navfooter"><table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="xyster.controller.actionhelpers.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="xyster.controller.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="xyster.data.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">4.2. Action Helpers </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> Chapter 5. Xyster_Data</td>
</tr>
</table></div>
<div class="revinfo"></div>
</body>
</html>
